{% extends "base.html" %}

{% block content %}
    <div class="content-container">
        {% if not task_list %}
            <h1 class="text-center">No tasks to show</h1>
        {% else %}
            <div class="tasks-container d-flex justify-content-center align-content-center gap-3">
                    {% for task in task_list %}
                        <div class="task-card d-flex" onclick="this.classList.toggle('flipped')">
                          <div class="task-card-inner">
                            <div class="task-card-front">
                              <div class="menu-container">
                                <details class="task-details">
                                      <summary></summary>
                                      <div class="popup-menu">
                                          {% if task.status == "pending" %}
                                            <p><a href="{% url 'edit-task' pk=task.pk %}?next={% url 'list-tasks' %}" class="times-new-roman">Edit</a></p>
                                          {% endif %}
                                          <p><a href="{% url 'delete-task' pk=task.pk %}?next={% url 'list-tasks' %}" class="times-new-roman">Delete</a></p>
                                      </div>
                                </details>
                              </div>
                              <h3>{{ task.name }}</h3>
                              <p class="date">Created at: {{ task.created_at }}</p>
                              <p class="status">Status: {{ task.status }}</p>
                              {% if task.accomplished_at %}
                                  <p class="date"> Completed at: </p>
                                  <p class="date">{{ task.accomplished_at }}</p>
                              {% else %}
                                  <p class="due-date">Due by: {{ task.due_by|date:"Y-m-d" }}</p>
                                  <div class="tooltip-container">
                                      <button type="button" class="complete-btn" data-task-id="{{ task.pk }}" data-task-url="{% url 'complete-task' task.pk %}">
                                        <i class="fa-solid fa-circle-check"></i>
                                      </button>
                                      <span class="tooltip-text-completed">Mark as completed</span>
                                  </div>
                              {% endif %}
                            </div>
                            <div class="task-card-back">
                              <p class="desc">{{ task.description }}</p>
                            </div>
                          </div>
                        </div>
                    {% endfor %}
            </div>
        </div>
    {% endif %}
<script>
const dueDateElements = document.querySelectorAll('.due-date');

dueDateElements.forEach(el => {
    const text = el.textContent;
    const dateStr = text.replace('Due by: ', '').trim();
    const dueDate = new Date(dateStr);
    const today = new Date();

    const diffTime = dueDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays >= 3) {
        el.style.color = 'green';
    } else if (diffDays === 2){
        el.style.color ='orange';
    } else if (diffDays <= 1) {
        el.style.color = 'red';
    }
});

document.querySelectorAll(".complete-btn").forEach(btn => {
    btn.addEventListener("click", function(event){
        event.stopPropagation();

        const button = this;
        const taskCard = button.closest(".task-card");
        const statusEl = taskCard.querySelector(".status");
        const dueDateEl = taskCard.querySelector(".due-date");
        const taskId = button.dataset.taskId;
        const url = button.dataset.taskUrl;

        fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success){
                statusEl.textContent = "Status: completed";
                if (dueDateEl) dueDateEl.remove();

                if(data.accomplished_at){
                   const completedDate = document.createElement("p");
                    completedDate.classList.add("date");
                    completedDate.textContent = `Completed at: ${data.accomplished_at}`;
                    taskCard.querySelector(".task-card-front").appendChild(completedDate);
                }


                button.remove();
            } else {
                console.error("Task completion failed:", data);
            }
        })
        .catch(err => {
            console.error("Fetch error:", err);
        });
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== ""){
        const cookies = document.cookie.split(";");
        for (let cookie of cookies){
            cookie = cookie.trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")){
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1 ));
                break;
            }
        }
    }
    return cookieValue;
}


const taskDetailsAll = document.querySelectorAll(".task-details");
taskDetailsAll.forEach(menu => {
    menu.addEventListener("click", function (e){
        e.stopPropagation();
    });

});

document.addEventListener("click", function (e) {
  taskDetailsAll.forEach(menu => {
    if (!menu.contains(e.target)) {
      menu.removeAttribute("open");
    }
  });
});

</script>

{% endblock %}